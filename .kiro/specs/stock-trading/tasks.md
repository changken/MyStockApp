# Implementation Plan

## Task 1: 核心資料模型與資料庫基礎建設
- [x] 1.1 (P) 建立交易領域列舉與值物件
  - 定義訂單方向（買入/賣出）、訂單類型（市價/限價）、訂單狀態（待成交/已成交/已取消）列舉
  - 定義市場類別（上市/上櫃）列舉供股票分類使用
  - 定義交易方向列舉供成交紀錄使用
  - 確保列舉值可正確儲存至資料庫
  - _Requirements: 1.1, 1.2, 2.1, 2.2, 3.1, 8.1_

- [x] 1.2 (P) 建立股票基本資料實體
  - 實作股票實體，包含代號、名稱、市場別、產業類別
  - 實作即時報價欄位：當前價、開盤價、最高價、最低價、成交量、更新時間
  - 設定股票代號唯一索引
  - 整合現有時間戳自動更新機制
  - _Requirements: 8.1, 8.2, 8.5_

- [x] 1.3 (P) 建立股價歷史紀錄實體
  - 實作歷史價格實體，包含日期、開高低收價格、成交量
  - 建立與股票實體的外鍵關聯
  - 設定日期與股票的複合索引以優化查詢
  - _Requirements: 9.1, 9.5_

- [x] 1.4 建立訂單與成交紀錄實體
  - 實作訂單實體，包含股票關聯、方向、類型、數量、價格、狀態、手續費、交易稅
  - 實作成交紀錄實體，包含訂單關聯、成交價、成交量、淨金額、手續費、交易稅
  - 建立訂單與成交的一對多關聯
  - 設定狀態與建立時間索引
  - _Requirements: 1.1, 1.2, 4.1, 7.7_

- [x] 1.5 建立持股部位與使用者設定實體
  - 實作持股實體，包含股票關聯、持有數量、平均成本、已實現損益
  - 實作使用者設定實體，包含電子下單折扣比例、單筆交易上限
  - 設定持股的股票唯一約束（每檔股票最多一筆記錄）
  - _Requirements: 5.1, 7.2, 7.8, 6.2_

- [x] 1.6 建立稽核日誌實體
  - 實作稽核日誌實體，包含操作類型、實體類型、實體識別碼、變更前後值、建立時間
  - 設定建立時間與實體類型索引以優化查詢
  - _Requirements: 6.3_

- [x] 1.7 擴充資料庫上下文與執行遷移
  - 在現有資料庫上下文中新增所有交易相關實體的資料集
  - 設定實體關聯與索引
  - 建立並執行資料庫遷移
  - 驗證資料表結構正確建立
  - _Requirements: 1.1, 1.2, 4.1, 5.1, 8.1, 9.1_

## Task 2: 交易成本計算服務
- [x] 2.1 (P) 實作手續費計算邏輯
  - 依據成交金額計算基礎手續費（0.1425%）
  - 套用電子下單折扣（預設 6 折）
  - 實作最低手續費門檻（20 元）
  - 驗證折扣範圍（1 折至 10 折）
  - _Requirements: 7.1, 7.2, 7.5, 7.8_

- [x] 2.2 (P) 實作證券交易稅計算邏輯
  - 計算賣出交易的證券交易稅（0.3%）
  - 買入交易不計算交易稅
  - 確保使用 decimal 類型避免精度問題
  - _Requirements: 7.3, 7.4_

- [x] 2.3 實作完整交易成本與損益預估
  - 整合手續費與交易稅計算，回傳完整成本明細
  - 根據交易方向決定成本組成（買入僅含手續費，賣出含手續費與交易稅）
  - 實作損益預估功能，計算當前市值、持股成本、未實現損益、報酬率
  - 預估損益需包含賣出時的預估成本
  - _Requirements: 5.2, 5.3, 7.6_

- [x] 2.4 交易成本服務單元測試
  - 測試一般金額手續費計算正確性
  - 測試最低手續費門檻觸發
  - 測試大額交易手續費計算
  - 測試不同折扣比例計算
  - 測試交易稅計算（買入為零、賣出正確）
  - 測試損益預估含成本計算
  - _Requirements: 7.1, 7.2, 7.3, 7.4, 7.5_

## Task 3: 股票資料管理服務
- [x] 3.1 (P) 實作股票基本資料查詢功能
  - 依據識別碼查詢單一股票
  - 依據股票代號查詢單一股票
  - 實作關鍵字搜尋（模糊比對代號與名稱）
  - 支援市場別與產業類別篩選
  - _Requirements: 8.1, 8.3, 8.4_

- [x] 3.2 (P) 實作股票報價更新功能
  - 更新股票即時報價（當前價、開高低價、成交量）
  - 自動記錄更新時間戳
  - 提供報價查詢介面供交易功能使用
  - _Requirements: 8.2, 8.5, 8.6_

- [x] 3.3 實作歷史價格資料管理
  - 查詢指定日期範圍的歷史價格
  - 計算價格統計（期間最高、最低、平均價格）
  - 計算漲跌幅百分比
  - 確保歷史資料保留至少一年
  - _Requirements: 9.1, 9.2, 9.3, 9.4, 9.5_

- [x] 3.4 實作每日收盤價寫入機制
  - 將當日收盤資料寫入歷史紀錄
  - 避免重複寫入同一交易日資料
  - 記錄寫入時間供追蹤使用
  - _Requirements: 9.6_

## Task 4: 市場時段與稽核服務
- [x] 4.1 (P) 實作台股交易時段判斷
  - 判斷當前時間是否為交易時段（週一至週五 09:00-13:25 台北時間）
  - 以台北時區判斷，需兼容 Windows/Linux 時區 ID（例如 Taipei Standard Time / Asia/Taipei）
  - 判斷指定日期是否為假日
  - 計算下一個開盤時間
  - 初始化 2025 年台灣股市假日清單
  - _Requirements: 6.4_

- [x] 4.2 (P) 實作稽核日誌記錄服務
  - 記錄交易操作至稽核日誌（操作類型、實體資訊、變更前後值）
  - 支援物件序列化為 JSON 儲存
  - 確保日誌記錄不影響主要業務流程效能
  - _Requirements: 6.3_

## Task 5: 交易訂單服務
- [x] 5.1 實作訂單建立與驗證邏輯
  - 驗證下單數量為正整數
  - 驗證股票代號存在且有效
  - 驗證限價單必須提供價格
  - 驗證賣出數量不超過持有股數
  - 檢查單筆交易金額是否超過設定上限並提示確認
  - 實作防重複提交機制（基於短時間內相同參數偵測）
  - _Requirements: 1.3, 1.4, 2.4, 6.1, 6.2, 6.5_

- [x] 5.2 實作市價單下單流程
  - 建立訂單並儲存至資料庫
  - 若為交易時段：以當前市價成交，建立 Trade、更新 Portfolio，並將訂單狀態更新為「已成交」（Executed）
  - 若為休市時段：訂單狀態維持「待成交」（Pending），不建立 Trade / 不更新 Portfolio，並回傳提示訊息
  - 使用資料庫交易確保 Order/Trade/Portfolio 原子性（交易時段成交情境）
  - 記錄稽核日誌
  - _Requirements: 1.1, 1.2, 1.5, 2.1, 2.5, 6.4, 7.7_

- [x] 5.3 實作限價單下單流程
  - 建立訂單並儲存至資料庫（包含限價）
  - 設定訂單狀態為「待成交」（Pending）
  - 定義觸發條件：買入市價 <= 限價；賣出市價 >= 限價
  - 觸發成交時：建立 Trade、更新 Portfolio，並將訂單狀態更新為「已成交」（Executed）
  - _Requirements: 2.2, 2.3_

- [x] 5.4 實作訂單查詢與篩選
  - 查詢所有訂單清單，包含完整資訊（代號、類型、數量、價格、狀態）
  - 支援依訂單狀態篩選（全部、待成交、已成交、已取消）
  - 依建立時間降序排列
  - _Requirements: 3.1, 3.5_

- [x] 5.5 實作訂單取消功能
  - 取消待成交訂單並更新狀態為已取消
  - 驗證訂單可取消（非已成交、非已取消）
  - 禁用已完成或已取消訂單的取消按鈕
  - 記錄取消操作至稽核日誌
  - _Requirements: 3.2, 3.3_

- [x] 5.6 實作待成交訂單成交處理（模擬）
  - 僅在開盤時段處理（MarketHoursService.IsMarketOpen）
  - 市價單（休市下單）：以處理當下市價成交並更新狀態
  - 限價單：依買/賣方向檢查觸發條件（買：市價 <= 限價；賣：市價 >= 限價）
  - 成交時建立 Trade、更新 Portfolio、更新訂單狀態、記錄稽核日誌
  - 使用資料庫交易確保 Order/Trade/Portfolio 原子性
  - 觸發方式：可由 UI 提供「處理待成交」按鈕或在頁面載入時呼叫一次
  - _Requirements: 2.2, 2.3, 4.1, 6.4_

## Task 6: 持股部位服務
- [ ] 6.1 實作持股計算與更新
  - 買入時更新平均成本（加權平均計算，含手續費）
  - 賣出時計算已實現損益
  - 更新持股數量
  - 當持股數量歸零時保留紀錄供歷史查詢
  - _Requirements: 5.1, 5.5_

- [ ] 6.2 實作損益計算功能
  - 計算每檔股票未實現損益（當前市值 - 持股成本 - 預估賣出成本）
  - 計算每檔股票報酬率百分比（考慮交易成本後的淨報酬率）
  - 計算投資組合總市值與總損益
  - 匯總已實現與未實現損益
  - _Requirements: 5.2, 5.3, 5.5_

- [ ] 6.3 實作即時損益更新
  - 當股價更新時重新計算損益數據
  - 提供持股摘要資訊（總市值、總成本、總損益、總報酬率）
  - _Requirements: 5.4, 5.5_

## Task 7: CSV 匯出服務
- [ ] 7.1 (P) 建立 JavaScript 下載輔助腳本
  - 新增檔案：`MyStockApp/wwwroot/js/fileDownload.js`
  - 建立檔案下載觸發函式
  - 支援 Base64 Data URI 格式
  - 設定正確的 MIME 類型與檔名
  - 在 `MyStockApp/Components/App.razor` 引入腳本（例如新增 `<script src="@Assets["js/fileDownload.js"]"></script>`）
  - _Requirements: 4.4_

- [ ] 7.2 實作交易紀錄 CSV 產生與匯出
  - 使用 CsvHelper 產生 CSV 內容
  - 包含完整交易資訊：日期、代號、類型、數量、價格、手續費、交易稅、淨金額
  - 透過 JavaScript Interop 觸發瀏覽器下載
  - 設定 UTF-8 BOM 確保 Excel 正確顯示中文
  - _Requirements: 4.4_

## Task 8: 交易紀錄查詢功能
- [ ] 8.1 實作交易紀錄查詢與篩選
  - 查詢已完成交易的完整紀錄
  - 支援依日期範圍篩選
  - 支援依股票代號搜尋
  - 依交易日期降序排列（最新在前）
  - _Requirements: 4.1, 4.2, 4.3, 4.5_

## Task 9: 服務註冊與整合
- [ ] 9. 註冊所有服務至依賴注入容器
  - 註冊 TradingService、TradingCostService 為 Scoped
  - 註冊 PortfolioService、StockService、AuditService 為 Scoped
  - 註冊 CsvExportService 為 Scoped
  - 註冊 MarketHoursService 為 Singleton
  - 確保服務介面與實作正確對應
  - _Requirements: 1.1, 1.2, 4.4, 5.1, 6.3, 7.1, 8.1_

## Task 10: 交易下單頁面
- [ ] 10.1 建立股票搜尋與選擇介面
  - 提供股票代號/名稱搜尋功能
  - 顯示搜尋結果清單供選擇
  - 選擇股票後顯示當前報價資訊
  - _Requirements: 8.3, 8.6_

- [ ] 10.2 建立下單表單介面
  - 提供買入/賣出選擇
  - 提供市價單/限價單類型選擇
  - 限價單時顯示價格輸入欄位，市價單時隱藏
  - 提供數量輸入欄位
  - 實作數量與價格驗證
  - _Requirements: 1.1, 1.2, 2.1, 2.2, 2.3, 2.5_

- [ ] 10.3 實作交易成本預估顯示
  - 輸入下單資訊後即時計算預估成本
  - 顯示手續費、交易稅、總成本明細
  - 顯示預估成交金額
  - _Requirements: 7.6_

- [ ] 10.4 實作下單確認與提交
  - 顯示休市時段提示訊息
  - 單筆金額超過上限時顯示警告並要求確認
  - 提交時顯示載入指示器並禁用按鈕
  - 顯示下單成功或失敗訊息
  - 實作防重複提交機制
  - _Requirements: 1.5, 6.2, 6.4, 6.5_

## Task 11: 訂單管理頁面
- [ ] 11.1 建立訂單清單顯示
  - 顯示所有訂單，包含股票代號、類型、數量、價格、狀態
  - 提供狀態篩選功能（全部、待成交、已成交、已取消）
  - 依建立時間排序
  - _Requirements: 3.1, 3.5_

- [ ] 11.2 實作訂單取消操作
  - 待成交訂單顯示取消按鈕
  - 已成交或已取消訂單禁用取消按鈕
  - 取消操作確認對話框
  - 取消成功後更新畫面顯示
  - _Requirements: 3.2, 3.3_

- [ ] 11.3 實作訂單狀態即時更新
  - 使用 SignalR 接收訂單狀態變更通知
  - 狀態變更時自動更新畫面
  - _Requirements: 3.4_

## Task 12: 持股部位頁面
- [ ] 12.1 建立持股清單顯示
  - 顯示所有持股，包含股票代號、名稱、數量、平均成本、當前市值
  - 顯示每檔股票未實現損益與報酬率
  - 以顏色區分盈虧（正數綠色、負數紅色）
  - _Requirements: 5.1, 5.2, 5.3_

- [ ] 12.2 實作投資組合摘要
  - 顯示總市值、總成本、總損益
  - 顯示已實現與未實現損益
  - 顯示總報酬率
  - _Requirements: 5.5_

- [ ] 12.3 實作損益即時更新
  - 股價更新時自動重新計算市值與損益
  - 提供手動重新整理功能
  - _Requirements: 5.4_

## Task 13: 交易紀錄頁面
- [ ] 13.1 建立交易紀錄清單顯示
  - 顯示完整交易資訊：日期、代號、類型、數量、價格、手續費、交易稅、淨金額
  - 依交易日期降序排列
  - _Requirements: 4.1, 4.5_

- [ ] 13.2 實作篩選與搜尋功能
  - 提供日期範圍選擇器
  - 提供股票代號搜尋欄位
  - 篩選條件變更時更新清單
  - _Requirements: 4.2, 4.3_

- [ ] 13.3 實作 CSV 匯出功能
  - 提供匯出按鈕
  - 匯出目前篩選結果
  - 檔案包含交易成本明細
  - 觸發瀏覽器下載
  - _Requirements: 4.4_

## Task 14: 導航選單整合
- [ ] 14. 更新導航選單
  - 新增「交易下單」導航項目
  - 新增「訂單管理」導航項目
  - 新增「持股部位」導航項目
  - 新增「交易紀錄」導航項目
  - 新增「股票查詢」導航項目
  - 股票查詢連結指向 Task 16.1（例如 `/stock-search`）
  - 確保導航連結正確指向新頁面
  - _Requirements: 1.1, 3.1, 4.1, 5.1, 8.3_

## Task 15: 整合測試與驗證
- [ ] 15.1 實作交易流程整合測試
  - 測試完整買入流程：下單 → 成交 → 持股更新
  - 測試完整賣出流程：下單 → 成交 → 損益計算 → 持股更新
  - 測試訂單取消流程
  - 測試交易成本計算正確性
  - _Requirements: 1.1, 1.2, 3.2, 5.1, 7.1, 7.3_

- [ ] 15.2 實作驗證邏輯測試
  - 測試無效數量錯誤訊息
  - 測試超賣錯誤訊息
  - 測試限價單未填價格錯誤
  - 測試無效股票代號錯誤
  - 測試金額上限警告
  - _Requirements: 1.3, 1.4, 2.4, 6.1, 6.2_

- [ ] 15.3 實作 CSV 匯出測試
  - 測試 CSV 內容格式正確
  - 測試中文字元正確顯示
  - 測試交易成本明細包含
  - _Requirements: 4.4_


## Task 16: 股票查詢與歷史資料頁面
- [ ] 16.1 建立股票查詢頁面
  - 新增獨立路由（例如 `/stock-search`）
  - 提供代號/名稱搜尋、市場別/產業篩選
  - 顯示搜尋結果清單並可選取股票
  - 選取後顯示即時報價（含更新時間）
  - _Requirements: 8.3, 8.4, 8.6_

- [ ] 16.2 建立歷史價格查詢與統計顯示
  - 提供日期範圍選擇
  - 顯示歷史價格清單（開高低收/成交量）
  - 顯示統計資訊（最高/最低/平均/漲跌幅）
  - _Requirements: 9.2, 9.3, 9.4_

## Requirements Coverage

| Requirement | Tasks |
|-------------|-------|
| 1.1, 1.2 | 1.4, 5.2, 10.2, 14, 15.1 |
| 1.3, 1.4 | 5.1, 15.2 |
| 1.5 | 5.2, 10.4 |
| 2.1, 2.2 | 1.1, 5.2, 5.3, 10.2 |
| 2.3, 2.4, 2.5 | 5.1, 5.3, 5.6, 10.2, 15.2 |
| 3.1, 3.5 | 1.1, 5.4, 11.1 |
| 3.2, 3.3 | 5.5, 11.2, 15.1 |
| 3.4 | 11.3 |
| 4.1, 4.5 | 1.4, 8.1, 13.1 |
| 4.2, 4.3 | 8.1, 13.2 |
| 4.4 | 7.1, 7.2, 13.3, 15.3 |
| 5.1 | 1.5, 6.1, 12.1, 14, 15.1 |
| 5.2, 5.3 | 2.3, 6.2, 12.1 |
| 5.4 | 6.3, 12.3 |
| 5.5 | 6.1, 6.2, 12.2 |
| 6.1 | 5.1, 15.2 |
| 6.2 | 1.5, 5.1, 10.4, 15.2 |
| 6.3 | 1.6, 4.2, 9 |
| 6.4 | 4.1, 5.2, 5.6, 10.4 |
| 6.5 | 5.1, 10.4 |
| 7.1, 7.2 | 2.1, 2.4 |
| 7.3, 7.4 | 2.2, 2.4 |
| 7.5 | 2.1, 2.4 |
| 7.6 | 2.3, 10.3 |
| 7.7 | 1.4, 5.2 |
| 7.8 | 1.5, 2.1 |
| 8.1 | 1.1, 1.2, 3.1, 9 |
| 8.2, 8.5 | 1.2, 3.2 |
| 8.3 | 3.1, 10.1, 14, 16.1 |
| 8.4 | 3.1, 16.1 |
| 8.6 | 3.2, 10.1, 16.1 |
| 9.1, 9.5 | 1.3, 3.3 |
| 9.2, 9.3, 9.4 | 3.3, 16.2 |
| 9.6 | 3.4 |
