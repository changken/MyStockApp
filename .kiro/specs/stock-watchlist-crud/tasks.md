# Implementation Plan

## Task Summary
- **Total**: 5 major tasks, 17 sub-tasks
- **Requirements Coverage**: All 6 requirements mapped
- **Parallel Execution**: Enabled (tasks marked with (P))
- **Estimated Duration**: 1-3 hours per sub-task

---

## Tasks

- [x] 1. 建立資料模型與資料庫結構
- [x] 1.1 建立 StockWatchlist Entity
  - 定義股票追蹤項目資料結構，包含代號、名稱、備註與時間戳欄位
  - 設定驗證規則：股票代號必須為 4 位數字（台股標準格式）
  - 設定欄位長度限制：名稱最多 100 字元，備註最多 500 字元
  - 配置必填與選填屬性（代號與名稱為必填，備註為選填）
  - _Requirements: 5.1, 5.2, 5.3, 6.4_

- [x] 1.2 擴充資料庫上下文
  - 註冊股票追蹤清單資料集至資料庫上下文
  - 配置股票代號唯一索引以防止重複新增
  - 設定建立時間預設值為當前時間戳
  - 實作更新時間自動更新機制
  - _Requirements: 6.1, 6.2, 6.3, 6.5_

- [x] 1.3 建立與執行資料庫遷移
  - 產生資料庫遷移檔案，建立股票追蹤清單資料表
  - 驗證遷移內容包含正確的資料表結構、唯一索引與預設值設定
  - 於測試環境執行資料庫更新
  - 測試插入重複股票代號應產生錯誤
  - _Requirements: 6.1, 6.5_

---

- [x] 2. 實作股票追蹤清單頁面基礎結構
- [x] 2.1 建立頁面骨架與資料載入
  - 建立股票追蹤清單頁面，設定路由路徑
  - 注入資料庫上下文工廠依賴
  - 定義頁面狀態：清單資料、表單模式、錯誤訊息、成功訊息、載入狀態
  - 實作頁面初始化時載入所有追蹤中的股票
  - _Requirements: 2.1, 6.3_

- [x] 2.2 實作清單顯示與載入指示器
  - 設計清單 UI 佈局，顯示股票代號、名稱與備註
  - 於每筆股票項目加入編輯與刪除操作按鈕
  - 實作載入中指示器，依載入狀態顯示
  - 處理空清單情境，顯示「目前無追蹤股票」提示
  - 實作清單依建立時間倒序排列（最新在前）
  - _Requirements: 2.1, 2.2, 2.3, 2.4, 2.5_

---

- [x] 3. 實作新增與編輯股票功能
- [x] 3.1 建立新增/編輯表單 UI
  - 建立表單元件綁定股票資料模型
  - 加入表單驗證與錯誤訊息顯示元件
  - 設計表單欄位：股票代號、股票名稱、備註輸入區
  - 根據表單模式調整標題與按鈕文字（新增 vs 編輯）
  - 編輯模式下股票代號欄位設為唯讀
  - 加入儲存與取消操作按鈕
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 3.1, 3.2, 3.3_

- [x] 3.2 (P) 實作新增股票邏輯
  - 實作「新增股票」按鈕點擊事件，顯示空白表單
  - 實作表單提交驗證與處理邏輯
  - 執行資料庫新增操作並處理儲存結果
  - 捕獲唯一約束違反錯誤，顯示「股票代號已存在」提示
  - 新增成功後顯示成功訊息，重新載入清單並清空表單
  - 自動設定建立時間與更新時間為當前時間
  - _Requirements: 1.5, 1.6, 1.7, 1.8, 5.4_

- [x] 3.3 (P) 實作編輯股票邏輯
  - 實作「編輯」按鈕點擊事件，預填現有股票資料至表單
  - 實作表單提交驗證與更新處理邏輯
  - 執行資料庫更新操作並處理儲存結果
  - 自動更新修改時間為當前時間
  - 更新成功後顯示成功訊息，重新載入清單並關閉表單
  - 實作「取消」按鈕邏輯，關閉表單且不儲存變更
  - _Requirements: 3.1, 3.4, 3.5, 3.6, 3.7, 5.4_

---

- [x] 4. 實作刪除股票功能
- [x] 4.1 建立刪除確認對話框 UI
  - 於頁面內嵌刪除確認對話框
  - 對話框內容顯示待刪除股票的代號與名稱
  - 加入「確認刪除」與「取消」操作按鈕
  - 實作對話框開關狀態控制
  - _Requirements: 4.1, 4.2_

- [x] 4.2 (P) 實作刪除股票邏輯
  - 實作「刪除」按鈕點擊事件，設定待刪除股票並顯示確認對話框
  - 實作「確認刪除」按鈕邏輯，執行資料庫刪除操作
  - 捕獲刪除操作異常，顯示錯誤訊息
  - 刪除成功後顯示成功訊息，重新載入清單並關閉對話框
  - 實作「取消」按鈕邏輯，關閉對話框且不執行刪除
  - _Requirements: 4.3, 4.4, 4.5, 4.6, 5.4_

---

- [x] 5. 整合導航、錯誤處理與測試
- [x] 5.1 整合導航選單
  - 於導航選單新增「股票追蹤」連結，指向股票追蹤頁面
  - 確保連結樣式符合既有導航選單慣例
  - 測試導航連結正確跳轉至目標頁面
  - _Requirements: 2.1_

- [x] 5.2 實作錯誤訊息與成功訊息顯示
  - 使用警示元件顯示錯誤訊息（紅色警示框）
  - 使用警示元件顯示成功訊息（綠色警示框）
  - 實作訊息自動清除機制（下次操作前清空）
  - 確保所有資料庫操作異常被捕獲並轉換為友善訊息
  - 記錄例外詳情至錯誤日誌
  - _Requirements: 5.4_

- [x] 5.3 驗證連線中斷處理
  - 確認既有的重新連線提示機制涵蓋股票追蹤頁面
  - 測試連線中斷情境，驗證重連提示正常顯示
  - 無需額外實作，僅驗證既有機制運作正常
  - _Requirements: 5.5_

- [x] 5.4 端對端功能測試
  - 測試完整新增流程：填寫表單 → 提交 → 驗證清單更新 → 驗證成功訊息
  - 測試完整編輯流程：點擊編輯 → 預填表單 → 修改 → 提交 → 驗證更新
  - 測試完整刪除流程：點擊刪除 → 確認對話框 → 確認刪除 → 驗證清單更新
  - 測試驗證錯誤顯示：提交空表單 → 驗證錯誤訊息於表單下方顯示
  - 測試重複股票代號處理：新增既有代號 → 驗證錯誤警示顯示
  - 測試空清單顯示：刪除所有股票 → 驗證「目前無追蹤股票」提示
  - 測試清單排序：新增多筆股票 → 驗證依建立時間倒序排列
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5, 1.6, 1.7, 1.8, 2.1, 2.2, 2.3, 2.4, 3.1, 3.2, 3.3, 3.4, 3.5, 3.6, 3.7, 4.1, 4.2, 4.3, 4.4, 4.5, 5.1, 5.2, 5.3_

- [x] 5.5 單元測試與整合測試（可選）
  - 撰寫股票資料模型驗證規則單元測試（必填、正則表達式、長度限制）
  - 撰寫股票代號格式驗證測試（有效：1234, 2330；無效：123, 12345, AAPL）
  - 撰寫 CRUD 操作整合測試（使用測試資料庫或記憶體資料庫）
  - 撰寫唯一約束測試（重複股票代號應產生資料庫更新例外）
  - 撰寫更新時間自動更新測試（驗證編輯後時間戳更新）
  - _Requirements: 1.7, 1.8, 5.1, 5.2, 5.3, 6.5_

---

## Requirements Coverage Matrix

| Requirement | Acceptance Criteria | Tasks |
|-------------|---------------------|-------|
| 1 (新增股票追蹤項目) | 1.1-1.8 | 3.1, 3.2, 5.4 |
| 2 (查詢股票追蹤清單) | 2.1-2.5 | 2.1, 2.2, 5.1, 5.4 |
| 3 (更新股票追蹤項目) | 3.1-3.7 | 3.1, 3.3, 5.4 |
| 4 (刪除股票追蹤項目) | 4.1-4.6 | 4.1, 4.2, 5.4 |
| 5 (資料驗證與錯誤處理) | 5.1-5.5 | 1.1, 3.2, 3.3, 4.2, 5.2, 5.3, 5.4, 5.5 |
| 6 (資料持久化) | 6.1-6.6 | 1.1, 1.2, 1.3, 2.1, 5.5 |

## Parallel Execution Strategy

**Tasks marked with (P) can be executed in parallel**:
- Task 3.2 (新增邏輯) 與 Task 3.3 (編輯邏輯) 可並行實作（共用表單 UI 已於 3.1 完成，邏輯獨立）
- Task 4.2 (刪除邏輯) 可與 Task 3.2/3.3 並行（對話框 UI 已於 4.1 完成，操作不同資料流程）

**Sequential Dependencies**:
- Task 1.x 必須依序完成（Entity → DbContext → Migration）
- Task 2.1 必須於 Task 1.3 完成後（需資料庫結構）
- Task 3.1, 4.1 必須於 Task 2.1 完成後（需頁面骨架）
- Task 3.2, 3.3, 4.2 必須於各自的 UI 任務完成後
- Task 5.x 必須於所有功能實作完成後（整合與測試）

## Implementation Notes

- **UpdatedAt 自動更新**: 於儲存變更前手動設定，或於資料庫上下文覆寫 SaveChangesAsync 方法中實作
- **表單與對話框**: 採用內嵌於頁面的 Razor 標記區塊，非獨立元件檔案
- **錯誤處理**: 所有資料庫操作使用 try-catch 包裝，唯一約束違反特別處理
- **測試策略**: Task 5.5 為可選測試任務，核心驗收透過 Task 5.4 端對端測試完成
